<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f7f7f7;
        padding: 40px;
      }

      .card {
        background: #fff;
        padding: 24px;
        border-radius: 6px;
        max-width: 800px;
        margin: auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      h2 {
        margin-top: 0;
        margin-bottom: 16px;
      }

      button {
        padding: 8px 14px;
        margin-bottom: 16px;
        border: 1px solid #ccc;
        background: #fafafa;
        cursor: pointer;
        border-radius: 4px;
      }

      button:hover {
        background: #eee;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        text-align: left;
        padding: 10px;
        border: 1px solid #ddd;
      }

      thead {
        background-color: #f2f2f2;
      }

      tbody tr:hover {
        background-color: #f9f9f9;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Part 1</h2>

      <button id="loadBtn">Load Users</button>

      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>City</th>
          </tr>
        </thead>
        <tbody id="userTableBody"></tbody>
      </table>
    </div>

    <div class="card" style="margin-top: 40px">
      <h2>Part 2</h2>

      <input id="userIdInput" placeholder="Enter User ID" />
      <button id="searchBtn">Search</button>

      <p id="errorMsg" style="color: red"></p>

      <h3>User Info</h3>
      <ul id="userInfoList"></ul>

      <h3>User Posts</h3>
      <ul id="userPostsList"></ul>

      <h3>User Todos</h3>
      <ul id="userTodosList"></ul>
    </div>
    <div class="card" style="margin-top: 40px">
      <h2>Part 3</h2>

      <button id="delayBtn">Delayed Request</button>

      <p id="delayMsg"></p>
    </div>
    <script>
      const loadBtn = document.getElementById("loadBtn");
      const tableBody = document.getElementById("userTableBody");

      const searchBtn = document.getElementById("searchBtn");
      const userIdInput = document.getElementById("userIdInput");

      const userInfoList = document.getElementById("userInfoList");
      const userPostsList = document.getElementById("userPostsList");
      const userTodosList = document.getElementById("userTodosList");
      const errorMsg = document.getElementById("errorMsg");

      searchBtn.addEventListener("click", searchUser);

      loadBtn.addEventListener("click", loadUsers);

      const delayBtn = document.getElementById("delayBtn");
      const delayMsg = document.getElementById("delayMsg");

      delayBtn.addEventListener("click", () => {
        delayMsg.textContent = "Waiting ...";
        delayedRequest(); // 使用默认 url
      });

      async function loadUsers() {
        try {
          loadBtn.disabled = true;

          const res = await fetch("https://jsonplaceholder.typicode.com/users");
          if (!res.ok) {
            throw new Error(`HTTP error: ${res.status}`);
          }

          const users = await res.json();

          tableBody.textContent = "";

          users.forEach((user) => {
            const tr = document.createElement("tr");

            const cells = [user.id, user.name, user.email, user.address.city];

            cells.forEach((value) => {
              const td = document.createElement("td");
              td.textContent = value;
              tr.appendChild(td);
            });

            tableBody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);

          tableBody.textContent = "";

          const tr = document.createElement("tr");
          const td = document.createElement("td");

          td.colSpan = 4;
          td.textContent = "Failed to load users";

          tr.appendChild(td);
          tableBody.appendChild(tr);
        } finally {
          loadBtn.disabled = false;
        }
      }

      async function searchUser() {
        const userId = userIdInput.value.trim();

        if (!userId) return;

        errorMsg.textContent = "";
        clearLists();

        try {
          const userUrl = `https://jsonplaceholder.typicode.com/users/${userId}`;
          const postsUrl = `https://jsonplaceholder.typicode.com/posts?userId=${userId}`;
          const todosUrl = `https://jsonplaceholder.typicode.com/todos?userId=${userId}`;

          const [userRes, postsRes, todosRes] = await Promise.all([
            fetch(userUrl),
            fetch(postsUrl),
            fetch(todosUrl),
          ]);

          const user = await userRes.json();
          const posts = await postsRes.json();
          const todos = await todosRes.json();

          if (!user.id) {
            showUserNotFound();
            return;
          }

          renderUserInfo(user);
          renderPosts(posts);
          renderTodos(todos);
        } catch (err) {
          console.error(err);
          errorMsg.textContent = "Something went wrong. Please try again.";
        }
      }

      function showUserNotFound() {
        errorMsg.textContent =
          "User was not found. Please try another user ID.";
        userIdInput.value = "";
        clearLists();
      }
      function clearLists() {
        userInfoList.innerHTML = "";
        userPostsList.innerHTML = "";
        userTodosList.innerHTML = "";
      }
      function renderUserInfo(user) {
        const info = {
          id: user.id,
          name: user.name,
          username: user.username,
          email: user.email,
          city: user.address.city,
          company: user.company.name,
        };

        for (const key in info) {
          const li = document.createElement("li");
          li.textContent = `${key}: ${info[key]}`;
          userInfoList.appendChild(li);
        }
      }
      function renderPosts(posts) {
        posts.forEach((post) => {
          const li = document.createElement("li");
          li.textContent = `title: ${post.title}`;
          userPostsList.appendChild(li);
        });
      }

      function renderTodos(todos) {
        todos.forEach((todo) => {
          const li = document.createElement("li");
          li.textContent = `title: ${todo.title}, completed: ${todo.completed}`;
          userTodosList.appendChild(li);
        });
      }

      async function delayedRequest(
        url = "https://jsonplaceholder.typicode.com/users/1",
      ) {
        try {
          const res = await fetch(url);
          const data = await res.json();

          setTimeout(() => {
            console.log(JSON.stringify(data));
            delayMsg.textContent = "Check console for the data";
          }, 2000);
        } catch (err) {
          console.error(err);
          delayMsg.textContent = "Request failed";
        }
      }
    </script>
  </body>
</html>
